package me.ht9.rose.feature.module.modules.exploit.infdurability;

import me.ht9.rose.event.bus.annotation.SubscribeEvent;
import me.ht9.rose.event.events.PacketEvent;
import me.ht9.rose.event.events.SyncCurrentItemEvent;
import me.ht9.rose.feature.module.Module;
import me.ht9.rose.feature.module.annotation.Description;
import me.ht9.rose.feature.module.setting.Setting;
import me.ht9.rose.mixin.accessors.INetClientHandler;
import me.ht9.rose.util.misc.CNetworkManager;
import net.minecraft.src.Packet14BlockDig;
import net.minecraft.src.Packet16BlockItemSwitch;

@Description("Infinite durability exploit. Put your item of choice in slot 10.")
public final class InfDurability extends Module
{
    private static final InfDurability instance = new InfDurability();

    private final Setting<Mode> mode = new Setting<>("Mode", Mode.Vanilla);
    private final Setting<Integer> bypassSlot = new Setting<>("NCSlot", 1, 1, 9, () -> mode.value().equals(Mode.NoCheat));

    @Override
    public void onDisable() {
        if (mc.getSendQueue() == null) return;
        mc.getSendQueue().addToSendQueue(new Packet16BlockItemSwitch(mc.thePlayer.inventory.currentItem));
    }

    @SuppressWarnings("unused")
    @SubscribeEvent
    public void onPacket(PacketEvent event)
    {
        if (!event.serverBound()) return;
        if (!(event.packet() instanceof Packet14BlockDig packet)) return;

        if (packet.status == 0 && mode.value().equals(Mode.NoCheat))
            mc.getSendQueue().addToSendQueue(new Packet16BlockItemSwitch(bypassSlot.value() - 1));

        if (packet.status == 2)
        {
            ((CNetworkManager)((INetClientHandler)mc.getSendQueue()).netManager()).rose_Babric$sendWithoutPacket(packet);
            mc.getSendQueue().addToSendQueue(new Packet16BlockItemSwitch(mc.thePlayer.inventory.currentItem));
            event.setCancelled(true);
        }
    }

    @SuppressWarnings("unused")
    @SubscribeEvent
    public void onCurrentItemSync(SyncCurrentItemEvent event)
    {
        if (event.type() == SyncCurrentItemEvent.Type.BREAK)
        {
            mc.getSendQueue().addToSendQueue(new Packet16BlockItemSwitch(9));
        }
        else
        {
            mc.getSendQueue().addToSendQueue(new Packet16BlockItemSwitch(mc.thePlayer.inventory.currentItem));
        }
        event.setCancelled(true);
    }

    public static InfDurability instance()
    {
        return instance;
    }

    public enum Mode
    {
        Vanilla,
        NoCheat
    }
}